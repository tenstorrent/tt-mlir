name: Build ttmlir Wheel

on:
  workflow_dispatch:
    inputs:
      same_branch:
        description: 'Run on the branch with same name in tt-forge as the current workflow'
        required: false
        type: boolean
      tt_forge_branch:
        description: 'Branch of tt-forge to run the benchmarks on (empty=main)'
        required: false
        type: string
      test_filter:
        description: "Only run tests with name that contains"
        required: false
        type: string

permissions:
  packages: write
  checks: write
  contents: write

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      mlir_sha: ${{ steps.get-mlir-sha.outputs.mlir_sha }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Get mlir sha
        id: get-mlir-sha
        run: |
          mlir_sha=$(git rev-parse HEAD)
          echo "Building with ttmlir sha: $mlir_sha"
          echo "mlir_sha=$mlir_sha" >> $GITHUB_OUTPUT

  build-forge-fe-image:
    uses: tenstorrent/tt-forge-fe/.github/workflows/build-image.yml@main
    needs: prepare
    secrets: inherit
    with:
      mlir_override: ${{ needs.prepare.outputs.mlir_sha }}

  build-forge-fe:
    uses: tenstorrent/tt-forge-fe/.github/workflows/build.yml@main
    needs: [build-forge-fe-image, prepare]
    secrets: inherit
    with:
      mlir_override: ${{ needs.prepare.outputs.mlir_sha }}
      docker-image: ${{ needs.build-forge-fe-image.outputs.docker-image }}
      build: Release

# xla
# torch

  run-perf-benchmarks:
    needs: build-forge-fe
    runs-on: ubuntu-latest
    steps:
      - id: set-inputs
        run: |
          if [ "${{ inputs.same_branch }}" == 'true' ]; then
            echo "ref=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          else
            if [ -z "${{ inputs.tt_forge_branch }}" ]; then
              echo "ref=main" >> $GITHUB_OUTPUT
            else
              echo "ref=${{ inputs.tt_forge_branch }}" >> $GITHUB_OUTPUT
            fi
          fi
      - name: Trigger Perf Benchmark workflow
        uses: peter-evans/repository-dispatch@v2
        with:
          token: ${{ secrets.GH_TOKEN }}
          repository: tenstorrent/tt-forge
          event-type: trigger-workflow
          client-payload: '{"project": "tt-forge-fe", "run_id": "${{ github.run_id }}", "ref": "${{ steps.set-inputs.outputs.ref }}", "test_filter": "${{ inputs.test_filter }}"}'
