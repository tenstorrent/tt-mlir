// SPDX-FileCopyrightText: (c) 2025 Tenstorrent AI ULC
//
// SPDX-License-Identifier: Apache-2.0

#include "ttmlir/Dialect/D2M/IR/D2M.h"
#include "ttmlir/Dialect/D2M/IR/D2MGenericRegionOps.h"
#include "ttmlir/Dialect/D2M/Utils/Utils.h"

#include "mlir/Dialect/Affine/IR/AffineOps.h"
#include "mlir/Dialect/Arith/IR/Arith.h"
#include "mlir/Dialect/Func/IR/FuncOps.h"
#include "mlir/Dialect/MemRef/IR/MemRef.h"
#include "mlir/IR/Builders.h"
#include "mlir/IR/MLIRContext.h"

#include <gtest/gtest.h>

namespace mlir::tt::d2m::utils {

namespace gtest = ::testing;

// Test fixture for D2M Utils tests.
struct D2MUtilsTest : public gtest::Test {
  void SetUp() override {
    ctx = std::make_unique<MLIRContext>();
    ctx->loadDialect<func::FuncDialect, mlir::tt::d2m::D2MDialect,
                     affine::AffineDialect, memref::MemRefDialect,
                     arith::ArithDialect>();
  }

  // Helper to create a test function with an empty region.
  func::FuncOp createTestFunction(OpBuilder &builder) {
    auto loc = builder.getUnknownLoc();
    auto module = ModuleOp::create(loc);
    builder.setInsertionPointToEnd(module.getBody());

    auto funcType = builder.getFunctionType({}, {});
    auto funcOp = builder.create<func::FuncOp>(loc, "test_func", funcType);
    funcOp.addEntryBlock();
    builder.setInsertionPointToEnd(&funcOp.getBody().front());
    return funcOp;
  }

  std::unique_ptr<MLIRContext> ctx;
};

// Test getRegionLargestDstElemType with empty region returns default f32.
TEST_F(D2MUtilsTest, GetRegionLargestDstElemTypeEmptyRegion) {
  OpBuilder builder(ctx.get());
  auto funcOp = createTestFunction(builder);
  Region &region = funcOp.getRegion();

  Type resultType = getRegionLargestDstElemType(region);
  ASSERT_TRUE(mlir::isa<mlir::FloatType>(resultType));
  auto floatType = mlir::cast<mlir::FloatType>(resultType);
  EXPECT_EQ(floatType.getWidth(), 32u);
}

// Test getSquareTargetGrid utility function.
TEST_F(D2MUtilsTest, GetSquareTargetGrid) {
  llvm::SmallVector<int64_t> result;

  result = getSquareTargetGrid({1, 4});
  EXPECT_EQ(result.size(), 2u);
  EXPECT_EQ(result[0], 1);
  EXPECT_EQ(result[1], 1);

  result = getSquareTargetGrid({6});
  EXPECT_EQ(result.size(), 1u);
  EXPECT_EQ(result[0], 6);

  result = getSquareTargetGrid({3, 5, 7});
  EXPECT_EQ(result.size(), 3u);
  EXPECT_EQ(result[0], 3);
  EXPECT_EQ(result[1], 3);
  EXPECT_EQ(result[2], 3);
}

} // namespace mlir::tt::d2m::utils
